% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit.R
\name{fit_poisson_log1p_nmf}
\alias{fit_poisson_log1p_nmf}
\alias{fit_poisson_log1p_nmf_control_default}
\title{Fit a Poisson NMF Model with log1p Link Function}
\usage{
fit_poisson_log1p_nmf(
  Y,
  K = NULL,
  s = NULL,
  cc = 1,
  init_LL = NULL,
  init_FF = NULL,
  loglik = c("default", "approx", "exact"),
  init_method = c("rank1", "random"),
  approx_technique = c("taylor", "chebyshev"),
  chebyshev_interval = NULL,
  control = list()
)

fit_poisson_log1p_nmf_control_default()
}
\arguments{
\item{Y}{an \eqn{n \times p} data matrix. For single cell data, this should
be a cells by genes matrix. Must be convertible to an object of
type \code{dgCMatrix}.}

\item{K}{rank of the factorization. Must be specified unless
\code{init_LL} and \code{init_FF} are provided.}

\item{s}{size factor for each row of \code{Y} used to scale the link function
(see Details). The default value of \code{NULL} will
use the row sums of \eqn{Y} scaled to have an average value of \eqn{1}.
Custom size factors can be provided with a numeric vector of length \eqn{n}.
If set to \code{FALSE}, no size factors will be used.}

\item{cc}{value of \code{c} in the link function. See Details.}

\item{init_LL}{initial value of \eqn{L}.}

\item{init_FF}{initial value of \eqn{F}.}

\item{loglik}{character string specifying the log-likelihood to optimize.
Setting this to \code{"approx"} will approximate the log-likelihood
corresponding to the \eqn{0} values of \eqn{Y} with a quadratic.
\code{"exact"} optimizes the true log-likelihood. Generally, this
approximation works poorly for values of \eqn{c} small relative to \eqn{1}
and well for values of \eqn{c} large relative to \eqn{1}. Thus, the
\code{"default"} method will use the approximate log likelihood for values
of \eqn{c \geq 1}.}

\item{init_method}{Method for initialization (ignored if \code{init_LL}
and \code{init_FF} are specified). \code{"random"} will initialize \eqn{L}
and \eqn{F} to small positive values generated from an exponential
distribution. \code{"rank1"} will initialize the first factor by fitting
a model with \eqn{K = 1} to the data, with all other factors initialized to
small positive values from an exponential distribution.}

\item{approx_technique}{technique used for quadratic approximation of terms
corresponding to \eqn{0} values of \eqn{Y} in the log likelihood. Method
\code{"taylor"} uses a second order Taylor approximation of \eqn{\exp(x)}
about \eqn{x = 0}. Method \code{"chebyshev"} uses the Chebyshev coefficients
to find the best quadratic approximation of \eqn{\exp(x)} in the
interval \code{chebyshev_interval}.}

\item{chebyshev_interval}{a sorted numeric vector of length 2
(e.g. \code{c(0, 1)}) specifying the interval for Chebyshev approximation of
the terms of the log likelihood correspond to \eqn{0} values of \eqn{Y}. Only
used when \code{loglik} is set accordingly and when \code{approx_technique}
is set to \code{"chebyshev"}. By default, the interval is set to
\eqn{[0, \log(1 + 1/c)]}, which best approximates values of \eqn{\lambda}
between \eqn{0} and \eqn{1}. See Details for more information.}

\item{control}{a list of control parameters. See Details for more
information.}
}
\value{
list with the following components
\describe{
  \item{LL}{Loadings of underlying mean structure. An \eqn{n \times K}.
  matrix}
  \item{FF}{Factors of underlying mean structure. A \eqn{p \times K} matrix.}
  \item{s}{An \eqn{n} vector of size factors used.}
  \item{control}{Control parameters used in optimization.}
  \item{converged}{Boolean indicating if numerical convergence was reached.}
  \item{objective_trace}{Vector with the value of the objective function at
  each iteration.}
  \item{approx_technique}{Approximating technique used in optimization
  (if at all).}
  \item{loglik}{Character indicating which objective was optimized.}
  \item{a1}{Value of linear coefficient in quadratic approximation
  (if used).}
  \item{a2}{Value of quadratic coefficient in quadratic approximation
  (if used).}
}
}
\description{
Fit a Poisson non-negative matrix factorization (NMF) model with
a log1p link using (approximate) maximum likelihood.
}
\details{
Here, we fit the model
\deqn{y_{ij} \sim \textrm{Poisson}(s_{i}\lambda_{ij})}
\deqn{\log(1 + \lambda_{ij} / c) = \sum_{k = 1}^{K} \ell_{ik}f_{jk},} where
\eqn{Y} is an \eqn{n \times p} matrix of non-negative counts, \eqn{L} is a
non-negative \eqn{n \times K} matrix of "loadings," \eqn{F} is a
non-negative \eqn{p \times K} matrix of "factors," \eqn{s_{i}} is a
"size-factor" controlling for the total size of the \eqn{i^{\textrm{th}}}
row of \eqn{Y}, and \eqn{c} is a tuning parameter controlling the shape of
the link function.

Exact optimization of the log-likelihood of this function can be slow, owing
mostly to the fact that \eqn{\exp(\sum_{k = 1}^{K} \ell_{ik}f_{jk})} must be
calculated for all \eqn{np} entries in \eqn{Y}. Especially for very sparse
data \eqn{Y}, the value of \eqn{\sum_{k = 1}^{K} \hat{\ell}_{ik}\hat{f}_{jk}}
evaluated at the maximum likelihood estimates \eqn{\hat{L}} and \eqn{\hat{F}}
is likely to be small for indices \eqn{(i, j)} where \eqn{y_{ij} = 0}. Thus,
we provide an approximate log-likelihood technique which approximates only
terms in the log-likelihood corresponding to indices \eqn{(i, j)} where
\eqn{y_{ij} = 0}. This approximation involves assumes
\eqn{\exp(x) \approx a_{0} + a_{1}x + a_{2}x^{2}} for some constants
\eqn{a_{0}}, \eqn{a_{1}}, and \eqn{a_{2}}. Selection of these constants can
be done either by a second order Taylor expansion about \eqn{x = 0} or by
optimizing a Chebyshev polynomial in a specified interval. Use of the
approximate technique can substantially increase the speed of computation,
but due to loss of accuracy we do not encourage it's use for values of
\eqn{c} smaller than \eqn{1}.

The \code{control} argument is a list in which any of the following
named components will override the default optimization algorithm
settings (as they are defined by
\code{fit_poisson_log1p_nmf_control_default}).

\describe{

\item{\code{maxiter}}{Maximum number of iterations for which to optimize
the full model.}

\item{\code{init_maxiter}}{Maximum number of iterations for which to optimize
the rank 1 approximation if \code{init_method} is set to \code{"rank1"}.}

\item{\code{ls_alpha}}{alpha parameter for backtracking line search.
  (Should be a number between 0 and 0.5, typically a number near
  zero.)}

\item{\code{ls_beta}}{beta parameter for backtracking line search
  controlling the rate at which the step size is decreased.
  (Should be a number between 0 and 0.5.)}

\item{\code{num_ccd_iter}}{Number of co-ordinate descent updates to
  be made to parameters at each iteration of the algorithm.}

\item{\code{tol}}{Numerical tolerance for determining convergence of the
(approximate) log-likelihood. Fitting will stop if the difference in
log-likelihood between successive iterations is below this number.}

\item{\code{verbose}}{Boolean indicating if information should be printed
indicating the progress of the algorithm.}

\item{\code{threads}}{Integer indicating the number of threads to be used
for optimization.}

}
}
\examples{
set.seed(1)
dat <- generate_log1p_pois_data(n = 500, p = 250, K = 4)

fit_out <- fit_poisson_log1p_nmf(
 Y = dat$Y,
 K = 4,
 init_method = "random",
 control = list(verbose = FALSE)
 )


}
